{% extends 'base.html' %}
{% block title %}{{ product.title }}{% endblock %}
{% block content %}
{% load static %}
{% load i18n %}

<div class="card mb-4 shadow">
  {% if product.image %}
    <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.title }}">
  {% else %}
    <img src="{% static 'images/no-image.png' %}" class="card-img-top" alt="No image">
  {% endif %}

  <div class="card-body">
    <h2 class="card-title">{{ product.title }}</h2>
    <p class="card-text">{{ product.description }}</p>
    <p class="card-text"><strong>{{ product.price }} –≥—Ä–Ω</strong></p>
    <p>{% translate 'Rating:' %} {{ average_rating }}</p>

    <form method="post"
          hx-post="{% url 'add-to-cart' product.pk %}"
          hx-target="#cart-button-{{ product.pk }}"
          hx-swap="outerHTML">
      {% csrf_token %}
      <button id="cart-button-{{ product.pk }}" type="submit" class="btn btn-primary mb-2">
        {% translate 'Add to cart' %}
      </button>
    </form>

    {% if user.is_authenticated and user.is_seller and product.seller == user %}
      <a href="{% url 'product-edit' product.pk %}" class="btn btn-warning">{% translate 'Edit' %}</a>
      <a href="{% url 'product-delete' product.pk %}" class="btn btn-danger">{% translate 'Delete' %}</a>
    {% endif %}
  </div>
</div>


<!-- üî•üî• AI –ü–û–ú–Ü–ß–ù–ò–ö ‚Äî –ü–†–ê–¶–Æ–Æ–ß–ê –í–ï–†–°–Ü–Ø -->
<h3 class="mt-4">AI –ü–æ–º—ñ—á–Ω–∏–∫</h3>

<div id="ai-chat-box" class="border p-3 mb-3"
     style="max-height: 300px; overflow-y: auto; background: #f8f9fa;">
</div>

<div class="input-group mb-3">
  <input id="ai-question" type="text" class="form-control"
         placeholder="–ü–æ—Å—Ç–∞–≤—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ç–æ–≤–∞—Ä...">

  <!-- ‚úî URL –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–Ω–æ–ø–∫–∏ ‚Äî –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ñ–≤ -->
  <button class="btn btn-primary"
          onclick="sendAIMessage('{% url 'product-ai-chat' product.id %}')">
    –ó–∞–ø–∏—Ç–∞—Ç–∏
  </button>
</div>

<script>
function sendAIMessage(url) {
    let input = document.getElementById("ai-question");
    let question = input.value.trim();
    if (!question) return;

    let chat = document.getElementById("ai-chat-box");
    chat.innerHTML += `<div><b>–í–∏:</b> ${question}</div>`;

    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: new URLSearchParams({ question: question })
    })
    .then(res => res.json())
    .then(data => {
        let answer = data.answer || "–ü–æ–º–∏–ª–∫–∞: –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è.";
        chat.innerHTML += `<div><b>AI:</b> ${answer}</div>`;
        chat.scrollTop = chat.scrollHeight;
    })
    .catch(err => {
        chat.innerHTML += `<div style="color:red;"><b>AI Error:</b> ${err}</div>`;
    });

    input.value = "";
}
</script>
<!-- üî• –ö—ñ–Ω–µ—Ü—å AI –±–ª–æ–∫—É -->


<hr>

<h3>{% translate 'Reviews' %}</h3>

{% include 'reviews/review_form.html' with product=product %}

<div id="reviews">
  {% for review in product.reviews.all %}
    {% include "reviews/review_item.html" with review=review %}
  {% empty %}
    <p>{% translate 'No reviews yet.' %}</p>
  {% endfor %}
</div>

{% endblock %}
